name: Pull Request Review

on:
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [synchronize, reopened]

jobs:
  Check-CodeRabbit-Approval:
    name: Check CodeRabbit Approval
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read

    steps:
      - name: Check CodeRabbit approval using GitHub Script
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const prNumber = context.payload.pull_request.number;
            const prHeadSha = context.payload.pull_request.head.sha;

            console.log(`Checking PR #${prNumber} on commit ${prHeadSha}`);

            function isCodeRabbitLogin(login) {
              if (!login) return false;
              const l = login.toLowerCase();
              return (
                l.includes("coderabbit") ||
                l.includes("coderabbitai") ||
                l.includes("coderabbit-ai")
              );
            }

            // Fast-path: handle CodeRabbit review event instantly
            if (context.eventName === "pull_request_review") {
              const rev = context.payload.review;
              if (rev && isCodeRabbitLogin(rev.user?.login)) {
                if (rev.state === "APPROVED" && rev.commit_id === prHeadSha) {
                  console.log("Fast-path success: CodeRabbit approved current commit.");
                  return;
                }
              }
            }

            let allReviews;
            try {
              allReviews = await github.paginate(
                github.rest.pulls.listReviews,
                { owner, repo, pull_number: prNumber }
              );
            } catch (err) {
              core.setFailed(`ERROR: Failed to fetch reviews: ${err.message}`);
              return;
            }

            console.log(`Total reviews: ${allReviews.length}`);

            const codeRabbitReviews = allReviews.filter(r =>
              isCodeRabbitLogin(r.user?.login)
            );

            if (codeRabbitReviews.length === 0) {
              core.setFailed("ERROR: No CodeRabbit reviews found yet.");
              return;
            }

            codeRabbitReviews.forEach(r =>
              console.log(
                `Review ${r.id}: ${r.state}, commit=${r.commit_id}, at=${r.submitted_at}`
              )
            );

            const approvedForHead = codeRabbitReviews.find(
              r => r.state === "APPROVED" && r.commit_id === prHeadSha
            );

            if (approvedForHead) {
              console.log("SUCCESS: CodeRabbit approved current commit.");
              return;
            }

            const approvals = codeRabbitReviews.filter(r => r.state === "APPROVED");

            if (approvals.length > 0) {
              const latestApproval = approvals.sort(
                (a, b) => new Date(b.submitted_at) - new Date(a.submitted_at)
              )[0];

              core.setFailed(
                `ERROR: Outdated CodeRabbit approval.\n` +
                `Latest approval commit: ${latestApproval.commit_id}\n` +
                `Current commit: ${prHeadSha}\n` +
                `New commits require fresh approval.`
              );
              return;
            }

            const latestReview = codeRabbitReviews.sort(
              (a, b) => new Date(b.submitted_at) - new Date(a.submitted_at)
            )[0];

            core.setFailed(
              `ERROR: CodeRabbit has not approved this PR.\n` +
              `Latest status: ${latestReview.state}`
            );
